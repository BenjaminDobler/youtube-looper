<div class="sidebar-container">
  <div class="sidebar-header">
    <h3>Loops</h3>
    <div class="header-actions">
      <span class="loop-count">{{ loops.length }}</span>
      @if (loops.length > 0) {
        <button 
          class="btn-share" 
          (click)="onShareLoops()"
          [title]="shareSuccess() ? 'Copied!' : 'Share loops'"
          [class.success]="shareSuccess()"
        >
          <app-icon name="share" [size]="14"></app-icon>
        </button>
      }
    </div>
  </div>

  @if (loops.length > 0) {
    <div class="loops-list">
      @for (loop of loops; track loop.id) {
        <div 
          class="loop-card"
          [class.active]="isActive(loop.id)"
          (click)="onToggleLoop(loop)"
        >
      <div class="loop-color-bar" [style.background]="loop.color"></div>
      
      <div class="loop-content">
        @if (!isEditing(loop.id)) {
          <!-- Loop name -->
          <div class="loop-name">
            {{ loop.name }}
          </div>
        } @else {
          <!-- Edit mode -->
          <div class="loop-edit" (click)="$event.stopPropagation()">
            <div class="edit-field">
              <label>Name:</label>
              <input 
                type="text" 
                [(ngModel)]="editingName"
                (keydown)="onInputKeydown($event)"
                (keydown.enter)="onSaveEdit(loop)"
                (keydown.escape)="onCancelEdit()"
                class="edit-input"
                autofocus
              />
            </div>
            <div class="edit-field">
              <label>Start:</label>
              <div class="time-input-group">
                <input 
                  type="text" 
                  [value]="formatTime(editingStartTime())"
                  (input)="onStartTimeChange($any($event.target).value)"
                  (keydown)="onInputKeydown($event)"
                  (keydown.enter)="onSaveEdit(loop)"
                  (keydown.escape)="onCancelEdit()"
                  class="edit-input time-input"
                  placeholder="MM:SS.mmm"
                />
                <button 
                  class="btn-target" 
                  (click)="onSetStartToCurrent()"
                  title="Set to current time"
                  type="button"
                >
                  <app-icon name="target" [size]="16"></app-icon>
                </button>
              </div>
            </div>
            <div class="edit-field">
              <label>End:</label>
              <div class="time-input-group">
                <input 
                  type="text" 
                  [value]="formatTime(editingEndTime())"
                  (input)="onEndTimeChange($any($event.target).value)"
                  (keydown)="onInputKeydown($event)"
                  (keydown.enter)="onSaveEdit(loop)"
                  (keydown.escape)="onCancelEdit()"
                  class="edit-input time-input"
                  placeholder="MM:SS.mmm"
                />
                <button 
                  class="btn-target" 
                  (click)="onSetEndToCurrent()"
                  title="Set to current time"
                  type="button"
                >
                  <app-icon name="target" [size]="16"></app-icon>
                </button>
              </div>
            </div>
            <div class="edit-field">
              <label>Pause:</label>
              <input 
                type="number" 
                [(ngModel)]="editingPauseDuration"
                (keydown)="onInputKeydown($event)"
                (keydown.enter)="onSaveEdit(loop)"
                (keydown.escape)="onCancelEdit()"
                class="edit-input time-input"
                placeholder="0"
                min="0"
                step="1"
              />
              <span class="field-hint">sec</span>
            </div>
            <div class="edit-field">
              <label>Speed:</label>
              <input 
                type="number" 
                [(ngModel)]="editingPlaybackSpeed"
                (keydown)="onInputKeydown($event)"
                (keydown.enter)="onSaveEdit(loop)"
                (keydown.escape)="onCancelEdit()"
                class="edit-input time-input"
                placeholder="1.0"
                min="0.25"
                max="2.0"
                step="0.25"
              />
              <span class="field-hint">Ã—</span>
            </div>
            <div class="edit-buttons">
              <button class="btn-save" (click)="onSaveEdit(loop)">
                <app-icon name="check" [size]="16"></app-icon>
              </button>
              <button class="btn-cancel" (click)="onCancelEdit()">
                <app-icon name="x" [size]="16"></app-icon>
              </button>
            </div>
          </div>
        }

        <!-- Loop info -->
        <div class="loop-info">
          <span class="time-range">{{ getLoopTimeRange(loop) }}</span>
          <span class="duration">{{ getLoopDuration(loop) }}</span>
        </div>

        <!-- Loop actions -->
        <div class="loop-actions" (click)="$event.stopPropagation()">
          <button 
            class="btn-action btn-edit" 
            (click)="onEditLoop(loop, $event)"
            title="Edit loop name"
          >
            <app-icon name="edit" [size]="14"></app-icon>
          </button>
          <button 
            class="btn-action btn-delete" 
            (click)="onDeleteLoop(loop, $event)"
            title="Delete loop"
          >
            <app-icon name="trash" [size]="14"></app-icon>
          </button>
        </div>
      </div>

      @if (isActive(loop.id)) {
        <!-- Active indicator -->
        <div class="active-indicator">
          <span class="pulse"></span>
          Playing
        </div>
      }
        </div>
      }
    </div>
  } @else {
    <div class="empty-state">
      <div class="empty-icon">
        <app-icon name="repeat" [size]="48"></app-icon>
      </div>
      <p>No loops yet</p>
      <p class="empty-hint">Click on the timeline below the video to create your first loop</p>
    </div>
  }
</div>
